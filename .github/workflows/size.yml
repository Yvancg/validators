name: size
on:
  push:
    branches: [ main ]
    paths:
      - 'is-*/**/*.js'
      - '.github/workflows/size.yml'
permissions:
  contents: write

jobs:
  size:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute sizes
        shell: bash
        run: |
          mkdir -p metrics
          # pick files you want to track
          files=("is-minify/minify.js" "is-url-safe/url.js" "is-phone-e164/phone.js")
          echo '{ "schemaVersion": 1, "label": "gzip", "message": "", "color": "blue" }' > metrics/_template.json
          for f in "${files[@]}"; do
            raw=$(wc -c < "$f" | xargs)
            gz=$(gzip -9 -c "$f" | wc -c | xargs)
            kb=$(awk "BEGIN{printf \"%.2fkB\", $gz/1024}")
            jq --arg msg "$kb" '.message=$msg' metrics/_template.json > "metrics/$(basename "$f").json"
            echo "$f -> raw=${raw}B, gzip=${gz}B"
          done
          rm metrics/_template.json

      - name: Commit JSON
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update gzip size metrics"
          file_pattern: metrics/*.json