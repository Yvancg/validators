name: update gzip metrics
on:
  push:
    branches: [ main ]
    paths:
      - '**/*.js'
  workflow_dispatch:

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute gzip sizes for all JS files
        run: |
          mkdir -p metrics
          echo "Scanning submodules for JS files..."

          find . -type f -name "*.js" ! -path "*/node_modules/*" | while read -r f; do
            [ "$f" = "./.github/workflows/size.yml" ] && continue
            size=$(gzip -c "$f" | wc -c | awk '{printf "%.2fkB", $1/1024}')

            # Extract base filename (e.g. card.js)
            base=$(basename "$f")

            # Write JSON to metrics/<filename>.json
            out="metrics/${base}.json"
            mkdir -p "$(dirname "$out")"
            echo "{\"schemaVersion\":1,\"label\":\"gzip\",\"message\":\"$size\",\"color\":\"blue\"}" > "$out"

            echo "→ $f → $out → $size"
          done

      - name: Commit and push updated metrics
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add metrics
          git diff --quiet && echo "No changes" || (git commit -m "chore: update gzip size metrics" && git push)
